This is the worst code I have ever written, but it works and is actually being used somewhere. You have been warned.  
